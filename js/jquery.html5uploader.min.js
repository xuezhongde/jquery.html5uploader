/*
 * File:        jquery.html5uploader.min.js
 * Version:     1.0.0
 * Author:      xuezd (xuezhongde@gmail.com)
 *
 */
(function(b){b.fn.html5uploader=function(c){c=b.extend({},b.fn.html5uploader.defaults,c);this.each(function(){var d=new a(this,c);d.init()})};var a=function(e,c){this.opts=c;var n=b(e),o,l,k,h=[],j=this;this.onUpload=c.onUpload;this.onUploadComplete=c.onUploadComplete;this.onUploadError=c.onUploadError;this.onDelete=c.onDelete;this.onFileSelected=c.onFileSelected;this.onFileSizePrevent=c.onFileSizePrevent;this.onFileTypePrevent=c.onFileTypePrevent;this.filter=function(r){var s=[];var t=h.length;for(var q=0;q<r.length;q++){var p=r[q];if(i(p)){j.onFileSizePrevent(p);continue}if(d(p)){j.onFileTypePrevent(p);continue}p.fileId="file-"+t++;h.push(p);s.push(p)}return s};this.fileSelected=function(s){j.onFileSelected(s);var t=j.filter(s);for(var r=0;r<t.length;r++){var q=t[r];var p=c.template;p=p.replace(/\${FILE_ID}/g,q.fileId).replace(/\${FILE_NAME}/g,q.name).replace(/\${FILE_SIZE}/g,f(q.size));k.append(p)}};this.uploadFile=function(r){j.onUpload(r);var p=b("#"+r.fileId).find(".file-upload-btn");var s=b("#"+r.fileId).find(".file-delete-btn");p.fadeOut();s.fadeOut();var t=new XMLHttpRequest();if(t.upload){t.upload.addEventListener("progress",function(u){m(r,u.loaded,u.total)},false);t.onreadystatechange=function(){if(t.readyState==4){if(t.status==200){j.onUploadComplete(r,t.responseText)}else{p.fadeIn();s.fadeIn();j.onUploadError(r,t.responseText)}}};t.open("POST",c.url,true);t.setRequestHeader("X_FILENAME",unescape(encodeURIComponent(r.name)));t.setRequestHeader("X-Requested-With","XMLHttpRequest");var q=new FormData();q.append(r.name,r);t.send(q)}};this.deleteFile=function(p){j.onDelete(p);b("#"+p.fileId).fadeOut()};this.init=function(){var p=[];p.push('<input type="file" style="display:none;" '+(c.multi?"multiple":"")+" />");p.push('<a class="file-selector" href="javascript:void(0);">'+c.buttonText+"</a>");p.push('<ol class="file-list"></ol>');n.append(p.join(""));l=n.find(":input[type=file]");o=n.find("a.file-selector");k=n.find("ol.file-list");o.on("click",function(){l.trigger("click")});l.on("change",function(r){var q=r.target.files||r.dataTransfer.files;j.fileSelected(q)});k.on("click","a.file-upload-btn",function(){var q=b(this).parent().attr("id");j.uploadFile(g(q,h))});k.on("click","a.file-delete-btn",function(){var q=b(this).parent().attr("id");j.deleteFile(g(q,h))})};var f=function(p){if(p>1024*1024){p=(Math.round(p/1024/1024*100)/100).toString()+"MB"}else{p=(Math.round(p/1024*100)/100).toString()+"KB"}return p};var g=function(p,r){for(var q=0;q<r.length;q++){if(r[q].fileId==p){return r[q]}}return false};var i=function(p){if(p.size>j.opts.maxFileSize){return true}return false};var d=function(p){if(p.type==""){return false}if(j.opts.blackListFileType!=""){if(p.type.match(j.opts.blackListFileType)){return true}}if(j.opts.allowedFileType==""){return false}return j.opts.allowedFileType.indexOf(p.type)<0};var m=function(r,q,s){var p=b("#"+r.fileId);p.find(".file-upload-progress-bar").css("width",(q/s*100).toFixed(2)+"%");p.find(".file-upload-progress-num").html(f(q)+"/"+f(s))}};b.fn.html5uploader.defaults={url:"",auto:false,multi:true,maxFileSize:100*1024*1024,blackListFileType:"",allowedFileType:"",buttonText:"选择文件",removeTimeout:1000,template:'<li class="file-item" id="${FILE_ID}"><div class="file-upload-progress"><div class="file-upload-progress-bar"></div></div><span class="file-name">${FILE_NAME}</span><span class="file-upload-progress-num">0/${FILE_SIZE}</span><a class="file-upload-btn">上传</a><a class="file-delete-btn">删除</a><span class="file-upload-status"></span></li>',onUpload:function(){},onUploadComplete:function(){},onUploadError:function(){},onDelete:function(){},onFileSelected:function(){},onFileSizePrevent:function(){},onFileTypePrevent:function(){}}})(jQuery);